<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>今天喝什么奶茶？</title>
  <style>
    :root {
      --bg: #f7f7f8;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --primary: #111111;
      --shadow: 0 6px 24px rgba(0,0,0,.06);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; color: var(--text); background: linear-gradient(#fff, var(--bg)); }
    .container { max-width: 520px; margin: 0 auto; padding: 16px; padding-bottom: 96px; }
    header.sticky { position: sticky; top: 0; background: rgba(255,255,255,.82); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border); padding: 12px 16px; margin: 0 -16px; }
    .row { display: flex; align-items: center; justify-content: space-between; }
    .title { font-weight: 800; font-size: 20px; }
    .btn { appearance: none; border: 1px solid var(--border); background: var(--card); color: var(--text); height: 40px; padding: 0 14px; border-radius: 999px; font-size: 14px; }
    .btn.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn.block { width: 100%; height: 48px; border-radius: 12px; font-weight: 700; }
    .btn:disabled { opacity: .55; }
    .muted { color: var(--muted); font-size: 13px; }
    .input { width: 100%; border: 1px solid var(--border); border-radius: 12px; padding: 12px 40px 12px 12px; font-size: 15px; }
    .clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 13px; background: transparent; border: none; }
    .pill { display: inline-flex; align-items: center; border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; font-size: 13px; margin: 0 8px 8px 0; background: #fff; }
    .pill.active { background: #111; color: #fff; border-color: #111; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); }
    .result { height: 82px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .result .name { font-size: 22px; font-weight: 900; text-align: center; }
    .result .placeholder { font-size: 18px; font-weight: 600; color: #9ca3af; }
    .grid-actions { display: grid; grid-template-columns: 1fr 112px; gap: 12px; }
    .flex { display: flex; flex-wrap: wrap; }
    .chip { border: 1px solid var(--border); padding: 6px 10px; border-radius: 999px; font-size: 13px; margin: 0 8px 8px 0; background: #fff; }
    .section-title { font-size: 15px; font-weight: 700; margin-bottom: 8px; }

    /* bottom sheet */
    .sheet-mask { position: fixed; inset: 0; background: rgba(0,0,0,.4); display: none; }
    .sheet { position: fixed; left: 0; right: 0; bottom: 0; background: #fff; border-top-left-radius: 20px; border-top-right-radius: 20px; transform: translateY(100%); transition: transform .26s ease; max-height: 80vh; overflow: auto; padding: 12px 16px 24px; }
    .sheet.open { transform: translateY(0); }
    .sheet-mask.open { display: block; }
    .sheet .handle { width: 48px; height: 6px; background: #e5e7eb; border-radius: 999px; margin: 6px auto 8px; }

    /* small helpers */
    .mt-2{margin-top:8px}.mt-3{margin-top:12px}.mt-4{margin-top:16px}.mt-6{margin-top:24px}.mt-8{margin-top:32px}.mb-24{margin-bottom:96px}
    .text-right{text-align:right}
    code{background:#f3f4f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="container">
    <header class="sticky">
      <div class="row">
        <div class="title">今天喝什么奶茶？</div>
        <button id="filterBtn" class="btn">筛选</button>
      </div>
      <div class="mt-3" style="position:relative">
        <input id="searchInput" class="input" placeholder="搜索名称（如：黑糖/芋泥）" />
        <button id="clearSearch" class="clear" style="display:none">清除</button>
      </div>
    </header>

    <div id="activeCatsWrap" class="mt-3 muted">未选择分类，默认包含全部。</div>

    <div id="stats" class="mt-2 muted">候选数量：0 / 总计 0</div>

    <div class="mt-4">
      <div class="card">
        <div class="muted">今日推荐</div>
        <div id="result" class="result">
          <div class="placeholder">点“抽一次”开始</div>
        </div>
        <div class="grid-actions mt-4">
          <button id="drawBtn" class="btn primary block">抽一次</button>
          <button id="clearBtn" class="btn">清空</button>
        </div>
      </div>
    </div>

    <div class="mt-6">
      <div class="muted" style="margin-bottom:6px">当前候选（点击可移除）：</div>
      <div id="chips" class="flex"></div>
      <div id="noMatch" class="muted" style="display:none">没有匹配项，请调整筛选条件。</div>
    </div>

    <div class="mt-8 mb-24">
      <div class="section-title">导入/管理奶茶名单</div>
      <div class="card">
        <div class="muted" style="margin-bottom:8px">粘贴名称列表（支持：<code>名字</code>；<code>名字,分类</code>；<code>名字|分类</code>）。也可上传 .txt/.csv。</div>
        <textarea id="importText" rows="5" class="input" style="height:auto" placeholder="例子：\n黑糖珍珠鲜奶,黑糖\n生椰拿铁,椰子\n珍珠奶茶"></textarea>
        <div class="row mt-3">
          <div style="display:flex; gap:12px; width:100%">
            <button id="importBtn" class="btn primary" style="flex:1">导入到列表</button>
            <input id="fileInput" type="file" accept=".txt,.csv" style="display:none" />
            <button id="uploadBtn" class="btn" style="width:112px">上传文件</button>
            <button id="resetBtn" class="btn" style="width:112px">恢复默认</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 筛选 Sheet -->
  <div id="sheetMask" class="sheet-mask"></div>
  <div id="sheet" class="sheet" aria-hidden="true">
    <div class="handle"></div>
    <div class="section-title">按分类筛选</div>
    <div class="muted mt-2">点击切换分类；再次点击可取消选择。</div>
    <div id="catPills" class="mt-3"></div>
    <div class="row mt-4">
      <button id="clearFilters" class="btn" style="flex:1">重置筛选</button>
      <button id="doneFilters" class="btn primary" style="flex:1">完成</button>
    </div>
  </div>

  <script>
    const DEFAULT_ITEMS = [
      { name: "珍珠奶茶", category: "经典" },
      { name: "红茶拿铁", category: "经典" },
      { name: "乌龙奶茶", category: "经典" },
      { name: "抹茶奶绿", category: "经典" },
      { name: "黑糖珍珠鲜奶", category: "黑糖" },
      { name: "黑糖波波奶茶", category: "黑糖" },
      { name: "桂花乌龙", category: "清爽" },
      { name: "四季春青茶", category: "清爽" },
      { name: "杨枝甘露", category: "水果" },
      { name: "多多绿", category: "水果" },
      { name: "葡萄芝芝", category: "芝士" },
      { name: "芝士茉莉绿", category: "芝士" },
      { name: "芋圆奶茶", category: "芋头" },
      { name: "芋泥鲜奶", category: "芋头" },
      { name: "椰椰生打椰", category: "椰子" },
      { name: "生椰拿铁", category: "椰子" },
      { name: "柠檬茶", category: "清爽" },
      { name: "百香果双响炮", category: "水果" },
      { name: "可可波波", category: "可可" },
      { name: "可可奶盖", category: "可可" },
    ];

    // --- State ---
    let items = [...DEFAULT_ITEMS];
    let query = "";
    let activeCats = [];
    let rolling = false;
    let current = null;

    // --- DOM refs ---
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const stats = document.getElementById('stats');
    const result = document.getElementById('result');
    const drawBtn = document.getElementById('drawBtn');
    const clearBtn = document.getElementById('clearBtn');
    const chips = document.getElementById('chips');
    const noMatch = document.getElementById('noMatch');
    const importText = document.getElementById('importText');
    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');
    const importBtn = document.getElementById('importBtn');
    const resetBtn = document.getElementById('resetBtn');

    const filterBtn = document.getElementById('filterBtn');
    const sheetMask = document.getElementById('sheetMask');
    const sheet = document.getElementById('sheet');
    const catPills = document.getElementById('catPills');
    const activeCatsWrap = document.getElementById('activeCatsWrap');
    const clearFilters = document.getElementById('clearFilters');
    const doneFilters = document.getElementById('doneFilters');

    // --- Helpers ---
    const setResult = (obj) => {
      current = obj;
      result.innerHTML = '';
      if (!obj) {
        const div = document.createElement('div');
        div.className = 'placeholder';
        div.textContent = '点“抽一次”开始';
        result.appendChild(div);
        return;
      }
      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = obj.name;
      result.appendChild(name);
    };

    const getAllCategories = () => Array.from(new Set(items.map(i => i.category))).sort();

    const getFiltered = () => {
      let arr = items;
      if (activeCats.length) arr = arr.filter(i => activeCats.includes(i.category));
      if (query.trim()) {
        const q = query.trim().toLowerCase();
        arr = arr.filter(i => i.name.toLowerCase().includes(q));
      }
      return arr;
    };

    const renderStats = () => {
      const f = getFiltered();
      stats.textContent = `候选数量：${f.length} / 总计 ${items.length}`;
      noMatch.style.display = f.length ? 'none' : 'block';
    };

    const renderChips = () => {
      chips.innerHTML = '';
      const f = getFiltered();
      f.forEach(i => {
        const b = document.createElement('button');
        b.className = 'chip';
        b.textContent = i.name;
        b.title = '移除此项';
        b.addEventListener('click', () => {
          items = items.filter(x => x.name !== i.name);
          renderAll();
        });
        chips.appendChild(b);
      });
    };

    const renderActiveCats = () => {
      activeCatsWrap.innerHTML = '';
      if (!activeCats.length) {
        activeCatsWrap.className = 'mt-3 muted';
        activeCatsWrap.textContent = '未选择分类，默认包含全部。';
        return;
      }
      activeCatsWrap.className = 'mt-3';
      activeCats.forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'pill active';
        btn.textContent = `${c} ✕`;
        btn.addEventListener('click', () => {
          activeCats = activeCats.filter(x => x !== c);
          renderAll();
        });
        activeCatsWrap.appendChild(btn);
      });
      const reset = document.createElement('button');
      reset.className = 'btn';
      reset.style.marginLeft = '6px';
      reset.textContent = '重置筛选';
      reset.addEventListener('click', () => { activeCats = []; renderAll(); });
      activeCatsWrap.appendChild(reset);
    };

    const renderSheet = () => {
      catPills.innerHTML = '';
      getAllCategories().forEach(c => {
        const btn = document.createElement('button');
        btn.className = 'pill' + (activeCats.includes(c) ? ' active' : '');
        btn.textContent = c;
        btn.addEventListener('click', () => {
          if (activeCats.includes(c)) activeCats = activeCats.filter(x => x !== c);
          else activeCats = [...activeCats, c];
          renderSheet();
        });
        catPills.appendChild(btn);
      });
    };

    const openSheet = () => {
      renderSheet();
      sheet.classList.add('open');
      sheetMask.classList.add('open');
      sheet.setAttribute('aria-hidden', 'false');
    };
    const closeSheet = () => {
      sheet.classList.remove('open');
      sheetMask.classList.remove('open');
      sheet.setAttribute('aria-hidden', 'true');
    };

    const renderAll = () => {
      renderStats();
      renderChips();
      renderActiveCats();
      // 如果当前结果不在候选中，清空
      const names = new Set(getFiltered().map(i => i.name));
      if (!current || !names.has(current.name)) setResult(null);
    };

    // --- Random draw with rolling animation ---
    const draw = () => {
      const f = getFiltered();
      if (!f.length || rolling) return;
      rolling = true;
      setResult(null);
      const duration = 1400; // ms
      const tick = 80; // ms
      const times = Math.max(10, Math.floor(duration / tick));
      let count = 0;
      const timer = setInterval(() => {
        setResult(f[Math.floor(Math.random() * f.length)]);
        count++;
        if (count >= times) {
          clearInterval(timer);
          setResult(f[Math.floor(Math.random() * f.length)]);
          rolling = false;
        }
      }, tick);
    };

    // --- Import ---
    const parseImportText = (text) => {
      const segs = text
        .split(/\r?\n|,|;|\t/)
        .map(s => s.trim())
        .filter(Boolean);
      const out = [];
      for (const s of segs) {
        const parts = s.split(/\s*\|\s*|\s*,\s*/);
        if (parts[0]) out.push({ name: parts[0], category: parts[1] || '自定义' });
      }
      return out;
    };

    const importList = (list) => {
      const existing = new Set(items.map(i => i.name));
      const merged = [...items, ...list.filter(x => !existing.has(x.name))];
      items = merged;
      importText.value = '';
      renderAll();
    };

    // --- Events ---
    searchInput.addEventListener('input', (e) => {
      query = e.target.value;
      clearSearch.style.display = query ? 'block' : 'none';
      renderAll();
    });
    clearSearch.addEventListener('click', () => { query = ''; searchInput.value=''; clearSearch.style.display='none'; renderAll(); });

    drawBtn.addEventListener('click', draw);
    clearBtn.addEventListener('click', () => setResult(null));

    filterBtn.addEventListener('click', openSheet);
    doneFilters.addEventListener('click', () => { closeSheet(); renderAll(); });
    clearFilters.addEventListener('click', () => { activeCats = []; renderSheet(); });
    sheetMask.addEventListener('click', closeSheet);

    uploadBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const text = await f.text();
      importText.value += (importText.value ? '\n' : '') + text;
      e.target.value = '';
    });
    importBtn.addEventListener('click', () => {
      const list = parseImportText(importText.value);
      if (list.length) importList(list);
    });
    resetBtn.addEventListener('click', () => {
      items = [...DEFAULT_ITEMS];
      activeCats = [];
      query = '';
      searchInput.value='';
      clearSearch.style.display='none';
      setResult(null);
      renderAll();
    });

    // --- init ---
    renderAll();
  </script>
</body>
</html>
